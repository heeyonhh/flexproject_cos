<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COS 온라인 스토어</title>
    <link rel="stylesheet" href="./style/login.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
</head>

<body>
    <div id="wrap">
        <div id="box">
            <a href="index.html" class="gohome">
                <i class="bi bi-x-lg"></i>
            </a>

            <!-- 로그아웃 상태 ui -->
            <div id="logoutbox">
                <p class="login">로그인</p>
                <div class="line hidden">null</div>
                <p class="padding">아이디 또는 이메일</p>
                <input type="id email">
                <p class="padding">비밀번호</p>
                <input type="password">
                <a href="#none" class="loginbutton">로그인</a>
                <div class="idsearch">
                    <a href="#none">아이디 찾기</a>
                    <a href="#none">비밀번호 찾기</a>
                </div>
                <p class="kakaoment">카카오 계정을 연동해 간편하게 로그인해보세요</p>
                <a href="javascript:kakaoLogin();" class="kakaologin">카카오 로그인</a>
                <p class="hdidment">COS 온라인 스토어는 더현대닷컴이 운영·제공하는 사이트로 기존 회원은 더현대닷컴 아이디와 비밀번호로 바로 이용 가능합니다.</p>
                <a href="#none" class="order">비회원 주문조회</a>
            </div>

            <!-- 로그인 상태 ui -->
            <div id="loginbox" style="display: none;">
                <p id="welcomeMessage"></p>
                <a href="javascript:kakaoLogout();">
                    <span>카카오 로그아웃</span>
                </a>
            </div>

        </div>
    </div>
</body>

<!-- 카카오 스크립트 -->
<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
<script>
    Kakao.init('767a22495c7396d75b6be80f52a05963'); //javascript키
    // console.log(Kakao.isInitialized()); // sdk초기화 여부 판단
    // 카카오 로그인
    function kakaoLogin() {
        Kakao.Auth.login({
            success: function (authObj) {
                Kakao.API.request({
                    url: '/v2/user/me',
                    success: function (response) {
                        console.log(response)
                        const name = response.properties.nickname;
                        const accessToken = authObj.access_token; // accessToken 가져오기
                    updatelogin(name, accessToken);
                        window.location.href = 'index.html';
                    },
                    fail: function (error) {
                        console.log(error)
                    },
                })
            },
            fail: function (error) {
                console.log(error)
            },
        })
    }
    // 카카오 로그아웃  
    function kakaoLogout() {
        if (Kakao.Auth.getAccessToken()) {
            Kakao.API.request({
                url: '/v1/user/unlink',
                success: function (response) {
                    console.log(response)
                    updatelogout();
                },
                fail: function (error) {
                    console.log(error)
                },
            })
            Kakao.Auth.setAccessToken(undefined)
        }
    }

    //로그인 후 ui
    function updatelogin(name, accessToken) {
        const loginbox = document.getElementById('loginbox');
        const logoutbox = document.getElementById('logoutbox');

        loginbox.style.display = 'block';
        logoutbox.style.display = 'none';
        welcomeMessage.textContent = `${name} 님 어서오세요.`;

        // index.loginLink 텍스트 변경
        const loginLink = document.querySelector('.loginLink');
        if (loginLink) {
            loginLink.textContent = `${name}님`;
        }

        // 로그인 유지하기 위해서 스토리지 저장
        localStorage.setItem('loggedIn', 'true');
        localStorage.setItem('accessToken', accessToken);
    }

    //로그아웃 ui 복원
    function updatelogout() {
        const loginbox = document.getElementById('loginbox');
        const logoutbox = document.getElementById('logoutbox');

        logoutbox.style.display = 'block';
        loginbox.style.display = 'none';

        const loginLink = document.querySelector('.loginLink');
        if (loginLink) {
            loginLink.textContent = '로그인';
        }

        // 로그인 스토리지 삭제
        localStorage.removeItem('loggedIn');
        localStorage.removeItem('accessToken');
    }

    //로그인 유지
    document.addEventListener('DOMContentLoaded', function () {
        const loggedIn = localStorage.getItem('loggedIn');
        const accessToken = localStorage.getItem('accessToken');

        if (loggedIn === 'true' && accessToken) {
            updatelogin(accessToken);
        } else {
            updatelogout();
        }
    });
</script>

</script>

</html>